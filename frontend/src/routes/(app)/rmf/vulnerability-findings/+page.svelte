<script lang="ts">
  import { onMount } from 'svelte';
  import { goto } from '$app/navigation';
  import VulnerabilityTable from '$lib/components/rmf/VulnerabilityTable.svelte';
  import CklUploadModal from '$lib/components/rmf/CklUploadModal.svelte';
  import { vulnerabilityFindingApi } from '$lib/services/rmf/api';
  import type { VulnerabilityFinding } from '$lib/services/rmf/api';

  import {
    Upload,
    Filter,
    Download,
    RefreshCw
  } from 'lucide-svelte';

  let findings: VulnerabilityFinding[] = [];
  let loading = true;
  let showUploadModal = false;
  let selectedSystemId: string | null = null;

  // Filters and pagination
  let currentPage = 1;
  let pageSize = 25;
  let totalCount = 0;
  let searchQuery = '';
  let statusFilter = '';
  let severityFilter = '';
  let checklistFilter = '';

  async function loadFindings() {
    loading = true;
    try {
      const params: Record<string, any> = {
        page: currentPage,
        page_size: pageSize
      };

      if (searchQuery) params.search = searchQuery;
      if (statusFilter) params.status = statusFilter;
      if (severityFilter) params.severity = severityFilter;
      if (checklistFilter) params.checklist_id = checklistFilter;

      const response = await vulnerabilityFindingApi.list(params);

      if (response.success) {
        findings = response.data.results || [];
        totalCount = response.data.count || 0;
      }
    } catch (error) {
      console.error('Error loading findings:', error);
    } finally {
      loading = false;
    }
  }

  async function handleBulkStatusUpdate(event: CustomEvent<{ findingIds: string[]; newStatus: string }>) {
    try {
      const { findingIds, newStatus } = event.detail;
      const response = await vulnerabilityFindingApi.bulkUpdateStatus(findingIds, newStatus);

      if (response.success) {
        // Reload findings to show updated status
        await loadFindings();
      } else {
        console.error('Bulk update failed:', response.message);
      }
    } catch (error) {
      console.error('Error in bulk status update:', error);
    }
  }

  function handleFindingSelected(event: CustomEvent<{ finding: VulnerabilityFinding }>) {
    const finding = event.detail.finding;
    goto(`/rmf/vulnerability-findings/${finding.id}`);
  }

  function handleFilterChanged(event: CustomEvent<{ filters: Record<string, any> }>) {
    const filters = event.detail.filters;
    searchQuery = filters.search || '';
    statusFilter = filters.status || '';
    severityFilter = filters.severity || '';
    currentPage = 1; // Reset to first page when filtering
    loadFindings();
  }

  onMount(async () => {
    await loadFindings();
  });

  $: if (currentPage || pageSize) {
    loadFindings();
  }
</script>

<svelte:head>
  <title>RMF Vulnerability Findings - CISO Assistant</title>
</svelte:head>

<div class="rmf-vulnerability-findings">
  <!-- Header -->
  <div class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="py-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">RMF Vulnerability Findings</h1>
            <p class="mt-1 text-sm text-gray-600">
              Review and manage STIG vulnerability findings across your systems
            </p>
          </div>
          <div class="flex items-center space-x-3">
            <button
              on:click={() => loadFindings()}
              disabled={loading}
              class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
            >
              <RefreshCw size={16} class={loading ? 'animate-spin' : ''} class="mr-2" />
              Refresh
            </button>
            <button
              on:click={() => showUploadModal = true}
              class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              <Upload size={16} class="mr-2" />
              Upload CKL
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="bg-white shadow rounded-lg">
      <VulnerabilityTable
        {findings}
        {loading}
        showBulkActions={true}
        on:findingSelected={handleFindingSelected}
        on:bulkStatusUpdate={handleBulkStatusUpdate}
        on:filterChanged={handleFilterChanged}
      />
    </div>

    <!-- Pagination -->
    {#if totalCount > pageSize}
      <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-gray-700">
          Showing {((currentPage - 1) * pageSize) + 1} to {Math.min(currentPage * pageSize, totalCount)} of {totalCount} findings
        </div>
        <div class="flex items-center space-x-2">
          <button
            on:click={() => currentPage--}
            disabled={currentPage <= 1}
            class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Previous
          </button>
          <span class="text-sm text-gray-700">
            Page {currentPage} of {Math.ceil(totalCount / pageSize)}
          </span>
          <button
            on:click={() => currentPage++}
            disabled={currentPage >= Math.ceil(totalCount / pageSize)}
            class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next
          </button>
        </div>
      </div>
    {/if}
  </div>
</div>

<!-- Upload Modal -->
<CklUploadModal
  bind:show={showUploadModal}
  systemGroupId={selectedSystemId}
  on:uploadComplete={() => {
    showUploadModal = false;
    loadFindings(); // Refresh the findings list
  }}
  on:close={() => { showUploadModal = false; selectedSystemId = null; }}
/>
