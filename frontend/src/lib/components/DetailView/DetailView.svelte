<script lang="ts">
	import { safeTranslate } from '$lib/utils/i18n';
	import { page } from '$app/stores';
	import ConfirmModal from '$lib/components/Modals/ConfirmModal.svelte';
	import CreateModal from '$lib/components/Modals/CreateModal.svelte';
	import MissingConstraintsModal from '$lib/components/Modals/MissingConstraintsModal.svelte';
	import ModelTable from '$lib/components/ModelTable/ModelTable.svelte';
	import type {
		ModalComponent,
		ModalSettings,
		ModalStore,
		ToastStore
	} from '@skeletonlabs/skeleton';
	import { TabGroup, Tab, getModalStore, getToastStore } from '@skeletonlabs/skeleton';
	import { breadcrumbObject } from '$lib/utils/stores';
	import { superForm } from 'sveltekit-superforms';
	import { getModelInfo } from '$lib/utils/crud.js';
	import { URL_MODEL_MAP } from '$lib/utils/crud';
	import { isURL } from '$lib/utils/helpers';
	import { toCamelCase } from '$lib/utils/locales.js';
	import { checkConstraints } from '$lib/utils/crud';
	import { languageTag } from '$paraglide/runtime.js';
	import * as m from '$paraglide/messages.js';
	import { ISO_8601_REGEX } from '$lib/utils/constants';
	import { formatDateOrDateTime } from '$lib/utils/datetime';
	import List from '$lib/components/List/List.svelte';

	const modalStore: ModalStore = getModalStore();
	const toastStore: ToastStore = getToastStore();

	const defaultExcludes = ['id', 'is_published', 'localization_dict'];

	export let data;
	export let mailing = false;
	export let fields: string[] = [];
	export let exclude: string[] = [];

	exclude = [...exclude, ...defaultExcludes];

	$: data.relatedModels = Object.fromEntries(Object.entries(data.relatedModels).sort());

	if (data.model.detailViewFields) {
		data.data = Object.fromEntries(
			Object.entries(data.data).filter(
				([key, _]) => data.model.detailViewFields.filter((field) => field.field === key).length > 0
			)
		);
	}

	$: breadcrumbObject.set(data.data);

	let tabSet = 0;

	function handleFormUpdated({
		form,
		pageStatus,
		closeModal
	}: {
		form: any;
		pageStatus: number;
		closeModal: boolean;
	}) {
		if (closeModal && form.valid) {
			$modalStore[0] ? modalStore.close() : null;
		}
		if (form.message) {
			const toast: { message: string; background: string } = {
				message: form.message,
				background: pageStatus === 200 ? 'variant-filled-success' : 'variant-filled-error'
			};
			toastStore.trigger(toast);
		}
	}

	function modalCreateForm(model: Record<string, any>): void {
		let modalComponent: ModalComponent = {
			ref: CreateModal,
			props: {
				form: model.createForm,
				model: model,
				debug: false
			}
		};
		let modal: ModalSettings = {
			type: 'component',
			component: modalComponent,
			// Data
			title: safeTranslate('add-' + model.info.localName)
		};
		if (checkConstraints(model.createForm.constraints, model.foreignKeys).length > 0) {
			modalComponent = {
				ref: MissingConstraintsModal
			};
			modal = {
				type: 'component',
				component: modalComponent,
				title: m.warning(),
				body: safeTranslate('add-' + model.info.localName).toLowerCase(),
				value: checkConstraints(model.createForm.constraints, model.foreignKeys)
			};
		}
		modalStore.trigger(modal);
	}

	function modalConfirm(id: string, name: string, action: string): void {
		const urlModel = getModelInfo('risk-acceptances').urlModel;
		const modalComponent: ModalComponent = {
			ref: ConfirmModal,
			props: {
				_form: { id: id, urlmodel: urlModel },
				id: id,
				debug: false,
				URLModel: urlModel,
				formAction: action
			}
		};
		const modal: ModalSettings = {
			type: 'component',
			component: modalComponent,
			// Data
			title: m.confirmModalTitle(),
			body: `${m.confirmModalMessage()}: ${name}?`
		};
		modalStore.trigger(modal);
	}

	function modalMailConfirm(id: string, name: string, action: string): void {
		const modalComponent: ModalComponent = {
			ref: ConfirmModal,
			props: {
				_form: { id: id, urlmodel: getModelInfo('compliance-assessments').urlModel },
				id: id,
				debug: false,
				URLModel: getModelInfo('compliance-assessments').urlModel,
				formAction: action,
				bodyComponent: List,
				bodyProps: {
					items: data.data.representatives,
					message: m.theFollowingRepresentativesWillReceiveTheQuestionnaireColon()
				}
			}
		};
		const modal: ModalSettings = {
			type: 'component',
			component: modalComponent,
			// Data
			title: m.confirmModalTitle(),
			body: m.sureToSendQuestionnaire({ questionnaire: name })
		};
		modalStore.trigger(modal);
	}

	const user = $page.data.user;
	const canEditObject: boolean = Object.hasOwn(user.permissions, `change_${data.model.name}`);

	$: displayEditButton = function () {
		return (
			canEditObject &&
			!['Accepted', 'Rejected', 'Revoked'].includes(data.data.state) &&
			!data.data.urn &&
			!data.data.builtin
		);
	};
</script>

<div class="flex flex-col space-y-2">
	{#if data.data.state === m.submitted() && $page.data.user.id === data.data.approver.id}
		<div
			class="flex flex-row space-x-4 items-center bg-yellow-100 rounded-container-token shadow px-6 py-2 mb-2 justify-between"
		>
			<div class="text-yellow-900">
				{m.riskAcceptanceReviewMessage()}
			</div>
			<div class="flex space-x-2">
				<button
					on:click={(_) => {
						modalConfirm(data.data.id, data.data.name, '?/accept');
					}}
					on:keydown={(_) => modalConfirm(data.data.id, data.data.name, '?/accept')}
					class="btn variant-filled-success"
				>
					<i class="fas fa-check mr-2" /> {m.validate()}</button
				>
				<button
					on:click={(_) => {
						modalConfirm(data.data.id, data.data.name, '?/reject');
					}}
					on:keydown={(_) => modalConfirm(data.data.id, data.data.name, '?/reject')}
					class="btn variant-filled-error"
				>
					<i class="fas fa-xmark mr-2" /> {m.reject()}</button
				>
			</div>
		</div>
	{:else if data.data.state === m.accept()}
		<div
			class="flex flex-row items-center space-x-4 bg-green-100 rounded-container-token shadow-lg px-6 py-2 mt-2 justify-between"
		>
			<div class="text-green-900">
				{m.riskAcceptanceValidatedMessage()}
			</div>
			{#if $page.data.user.id === data.data.approver.id}
				<div class="ml-auto whitespace-nowrap">
					<button
						on:click={(_) => {
							modalConfirm(data.data.id, data.data.name, '?/revoke');
						}}
						on:keydown={(_) => modalConfirm(data.data.id, data.data.name, '?/revoke')}
						class="btn variant-filled-error"
					>
						<i class="fas fa-xmark mr-2" /> {m.revoke()}</button
					>
				</div>
			{/if}
		</div>
	{/if}
	<div class="card shadow-lg bg-white flex flex-row p-4 justify-between">
		<div class="flow-root rounded-lg border border-gray-100 py-3 shadow-sm w-3/4">
			<dl class="-my-3 divide-y divide-gray-100 text-sm">
				{#each Object.entries(data.data).filter( ([key, _]) => (fields.length > 0 ? fields.includes(key) : true && !exclude.includes(key)) ) as [key, value]}
					<div class="grid grid-cols-1 gap-1 py-3 px-2 even:bg-gray-50 sm:grid-cols-3 sm:gap-4">
						<dt class="font-medium text-gray-900" data-testid="{key.replace('_', '-')}-field-title">
							{safeTranslate(key)}
						</dt>
						<dd class="text-gray-700 sm:col-span-2">
							<ul class="">
								<li
									class="list-none"
									data-testid={!(value instanceof Array)
										? key.replace('_', '-') + '-field-value'
										: null}
								>
									{#if value !== null && value !== undefined && value !== ''}
										{#if key === 'library'}
											{@const itemHref = `/libraries/${value.id}?loaded`}
											<a href={itemHref} class="anchor">{value.name}</a>
										{:else if key === 'severity'}
											<!-- We must add translations for the following severity levels -->
											<!-- Is this a correct way to convert the severity integer to the stringified security level ? -->
											{@const stringifiedSeverity =
												value < 0
													? '--'
													: (safeTranslate(['low', 'medium', 'high', 'critical'][value]) ??
														m.undefined())}
											{stringifiedSeverity}
										{:else if Array.isArray(value)}
											{#if Object.keys(value).length > 0}
												<ul>
													{#each value as val}
														<li data-testid={key.replace('_', '-') + '-field-value'}>
															{#if val.str && val.id}
																{@const itemHref = `/${
																	URL_MODEL_MAP[data.urlModel]['foreignKeyFields']?.find(
																		(item) => item.field === key
																	)?.urlModel
																}/${val.id}`}
																<a href={itemHref} class="anchor">{val.str}</a>
															{:else}
																{value}
															{/if}
														</li>
													{/each}
												</ul>
											{:else}
												--
											{/if}
										{:else if value.id}
											{@const itemHref = `/${
												URL_MODEL_MAP[data.urlModel]['foreignKeyFields']?.find(
													(item) => item.field === key
												)?.urlModel
											}/${value.id}`}
											<a href={itemHref} class="anchor">{value.str}</a>
										{:else if isURL(value) && !value.startsWith('urn')}
											<a href={value} target="_blank" class="anchor">{value}</a>
										{:else if ISO_8601_REGEX.test(value)}
											{formatDateOrDateTime(value, languageTag())}
										{:else if m[toCamelCase((value.str || value.name) ?? value)]}
											{safeTranslate((value.str || value.name) ?? value)}
										{:else}
											{(value.str || value.name) ?? value}
										{/if}
									{:else}
										--
									{/if}
								</li>
							</ul>
						</dd>
					</div>
				{/each}
			</dl>
		</div>
		<div class="">
			{#if mailing}
				<button
					class="btn variant-filled-primary h-fit"
					on:click={(_) => {
						modalMailConfirm(
							data.data.compliance_assessment.id,
							data.data.compliance_assessment.str,
							'?/mailing'
						);
					}}
					on:keydown={(_) =>
						modalMailConfirm(
							data.data.compliance_assessment.id,
							data.data.compliance_assessment.str,
							'?/mailing'
						)}
				>
					<i class="fas fa-paper-plane mr-2" />
					{m.sendQuestionnaire()}
				</button>
			{/if}
			{#if displayEditButton()}
				<a
					href={`${$page.url.pathname}/edit?next=${$page.url.pathname}`}
					class="btn variant-filled-primary h-fit"
					><i class="fa-solid fa-pen-to-square mr-2" data-testid="edit-button" />{m.edit()}</a
				>
			{/if}
		</div>
	</div>
</div>

{#if Object.keys(data.relatedModels).length > 0}
	<div class="card shadow-lg mt-8 bg-white">
		<TabGroup justify="justify-center">
			{#each Object.entries(data.relatedModels) as [urlmodel, model], index}
				<Tab bind:group={tabSet} value={index} name={`${urlmodel}_tab`}>
					{safeTranslate(model.info.localNamePlural)}
					{#if model.table.body.length > 0}
						<span class="badge variant-soft-secondary">{model.table.body.length}</span>
					{/if}
				</Tab>
			{/each}
			<svelte:fragment slot="panel">
				{#each Object.entries(data.relatedModels) as [urlmodel, model], index}
					{#if tabSet === index}
						<div class="flex flex-row justify-between px-4 py-2">
							<h4 class="font-semibold lowercase capitalize-first my-auto">
								{safeTranslate('associated-' + model.info.localNamePlural)}
							</h4>
						</div>
						{#if model.table}
							<ModelTable source={model.table} deleteForm={model.deleteForm} URLModel={urlmodel}>
								<button
									slot="addButton"
									class="btn variant-filled-primary self-end my-auto"
									on:click={(_) => modalCreateForm(model)}
									><i class="fa-solid fa-plus mr-2 lowercase" />{safeTranslate(
										'add-' + model.info.localName
									)}</button
								>
							</ModelTable>
						{/if}
					{/if}
				{/each}
			</svelte:fragment>
		</TabGroup>
	</div>
{/if}
