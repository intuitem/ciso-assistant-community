<script lang="ts">
  import { createEventDispatcher } from 'svelte';
  import {
    AlertTriangle,
    CheckCircle,
    XCircle,
    Clock,
    Filter,
    Search,
    ChevronDown,
    ChevronUp,
    MoreHorizontal,
    Edit,
    Eye
  } from 'lucide-svelte';
  import type { VulnerabilityFinding } from '$lib/services/rmf/api';

  export let findings: VulnerabilityFinding[] = [];
  export let loading = false;
  export let selectedFindings: string[] = [];
  export let showBulkActions = true;

  const dispatch = createEventDispatcher<{
    findingSelected: { finding: VulnerabilityFinding };
    statusUpdate: { findingId: string; newStatus: string };
    bulkStatusUpdate: { findingIds: string[]; newStatus: string };
    filterChanged: { filters: Record<string, any> };
  }>();

  // Filter and search state
  let searchQuery = '';
  let statusFilter = '';
  let severityFilter = '';
  let sortField = 'ruleTitle';
  let sortDirection: 'asc' | 'desc' = 'asc';

  // UI state
  let showFilters = false;

  $: filteredFindings = findings.filter(finding => {
    const matchesSearch = !searchQuery ||
      finding.ruleTitle.toLowerCase().includes(searchQuery.toLowerCase()) ||
      finding.vulnId.toLowerCase().includes(searchQuery.toLowerCase()) ||
      finding.stigId.toLowerCase().includes(searchQuery.toLowerCase());

    const matchesStatus = !statusFilter || finding.vulnerability_status.status === statusFilter;
    const matchesSeverity = !severityFilter || finding.severity.category === severityFilter;

    return matchesSearch && matchesStatus && matchesSeverity;
  });

  $: sortedFindings = [...filteredFindings].sort((a, b) => {
    let aVal = a[sortField as keyof VulnerabilityFinding];
    let bVal = b[sortField as keyof VulnerabilityFinding];

    if (typeof aVal === 'string' && typeof bVal === 'string') {
      const comparison = aVal.localeCompare(bVal);
      return sortDirection === 'asc' ? comparison : -comparison;
    }

    return 0;
  });

  function getStatusIcon(status: string) {
    switch (status) {
      case 'open':
        return AlertTriangle;
      case 'not_a_finding':
        return CheckCircle;
      case 'not_applicable':
        return XCircle;
      case 'not_reviewed':
        return Clock;
      default:
        return Clock;
    }
  }

  function getStatusColor(status: string) {
    switch (status) {
      case 'open':
        return 'text-red-600 bg-red-50';
      case 'not_a_finding':
        return 'text-green-600 bg-green-50';
      case 'not_applicable':
        return 'text-gray-600 bg-gray-50';
      case 'not_reviewed':
        return 'text-yellow-600 bg-yellow-50';
      default:
        return 'text-gray-600 bg-gray-50';
    }
  }

  function getSeverityColor(category: string) {
    switch (category) {
      case 'cat1':
        return 'text-red-700 bg-red-100';
      case 'cat2':
        return 'text-orange-700 bg-orange-100';
      case 'cat3':
        return 'text-yellow-700 bg-yellow-100';
      default:
        return 'text-gray-700 bg-gray-100';
    }
  }

  function toggleSort(field: string) {
    if (sortField === field) {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      sortField = field;
      sortDirection = 'asc';
    }
  }

  function toggleFindingSelection(findingId: string) {
    if (selectedFindings.includes(findingId)) {
      selectedFindings = selectedFindings.filter(id => id !== findingId);
    } else {
      selectedFindings = [...selectedFindings, findingId];
    }
  }

  function toggleAllSelections() {
    if (selectedFindings.length === sortedFindings.length) {
      selectedFindings = [];
    } else {
      selectedFindings = sortedFindings.map(f => f.id);
    }
  }

  function handleBulkStatusUpdate(newStatus: string) {
    if (selectedFindings.length > 0) {
      dispatch('bulkStatusUpdate', {
        findingIds: selectedFindings,
        newStatus
      });
    }
  }

  function applyFilters() {
    dispatch('filterChanged', {
      search: searchQuery,
      status: statusFilter,
      severity: severityFilter
    });
  }

  function clearFilters() {
    searchQuery = '';
    statusFilter = '';
    severityFilter = '';
    applyFilters();
  }
</script>

<div class="vulnerability-table">
  <!-- Header with filters -->
  <div class="bg-white border-b border-gray-200 px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <h2 class="text-lg font-semibold text-gray-900">Vulnerability Findings</h2>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
          {filteredFindings.length} of {findings.length}
        </span>
      </div>

      <div class="flex items-center space-x-3">
        {#if showBulkActions && selectedFindings.length > 0}
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600">{selectedFindings.length} selected</span>
            <select
              class="text-sm border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
              on:change={(e) => handleBulkStatusUpdate(e.target.value)}
            >
              <option value="">Bulk Update Status</option>
              <option value="open">Open</option>
              <option value="not_a_finding">Not a Finding</option>
              <option value="not_applicable">Not Applicable</option>
              <option value="not_reviewed">Not Reviewed</option>
            </select>
          </div>
        {/if}

        <button
          on:click={() => showFilters = !showFilters}
          class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          <Filter size={16} class="mr-2" />
          Filters
        </button>
      </div>
    </div>

    {#if showFilters}
      <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
            <div class="relative">
              <Search size={16} class="absolute left-3 top-3 text-gray-400" />
              <input
                type="text"
                bind:value={searchQuery}
                on:input={applyFilters}
                placeholder="Search vulnerabilities..."
                class="pl-10 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select
              bind:value={statusFilter}
              on:change={applyFilters}
              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Statuses</option>
              <option value="open">Open</option>
              <option value="not_a_finding">Not a Finding</option>
              <option value="not_applicable">Not Applicable</option>
              <option value="not_reviewed">Not Reviewed</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>
            <select
              bind:value={severityFilter}
              on:change={applyFilters}
              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Severities</option>
              <option value="cat1">CAT I (High)</option>
              <option value="cat2">CAT II (Medium)</option>
              <option value="cat3">CAT III (Low)</option>
            </select>
          </div>
        </div>

        <div class="mt-3 flex justify-end">
          <button
            on:click={clearFilters}
            class="text-sm text-gray-600 hover:text-gray-800 underline"
          >
            Clear filters
          </button>
        </div>
      </div>
    {/if}
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          {#if showBulkActions}
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <input
                type="checkbox"
                checked={selectedFindings.length === sortedFindings.length && sortedFindings.length > 0}
                indeterminate={selectedFindings.length > 0 && selectedFindings.length < sortedFindings.length}
                on:change={toggleAllSelections}
                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
            </th>
          {/if}
          <th class="px-6 py-3 text-left">
            <button
              on:click={() => toggleSort('vulnId')}
              class="flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700"
            >
              Vuln ID
              {#if sortField === 'vulnId'}
                <svelte:component this={sortDirection === 'asc' ? ChevronUp : ChevronDown} size={14} class="ml-1" />
              {/if}
            </button>
          </th>
          <th class="px-6 py-3 text-left">
            <button
              on:click={() => toggleSort('ruleTitle')}
              class="flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700"
            >
              Title
              {#if sortField === 'ruleTitle'}
                <svelte:component this={sortDirection === 'asc' ? ChevronUp : ChevronDown} size={14} class="ml-1" />
              {/if}
            </button>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Severity
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Status
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            STIG ID
          </th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {#each sortedFindings as finding}
          <tr class="hover:bg-gray-50">
            {#if showBulkActions}
              <td class="px-6 py-4 whitespace-nowrap">
                <input
                  type="checkbox"
                  checked={selectedFindings.includes(finding.id)}
                  on:change={() => toggleFindingSelection(finding.id)}
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
              </td>
            {/if}
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">{finding.vulnId}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-900 max-w-xs truncate" title={finding.ruleTitle}>
                {finding.ruleTitle}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {getSeverityColor(finding.severity.category)}">
                {finding.severity.name}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {getStatusColor(finding.vulnerability_status.status)}">
                <svelte:component this={getStatusIcon(finding.vulnerability_status.status)} size={12} class="mr-1" />
                {finding.display_status || finding.vulnerability_status.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {finding.stigId}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="flex items-center justify-end space-x-2">
                <button
                  on:click={() => dispatch('findingSelected', { finding })}
                  class="text-blue-600 hover:text-blue-900"
                  title="View Details"
                >
                  <Eye size={16} />
                </button>
                <button
                  on:click={() => dispatch('statusUpdate', { findingId: finding.id, newStatus: 'open' })}
                  class="text-gray-600 hover:text-gray-900"
                  title="Edit Status"
                >
                  <Edit size={16} />
                </button>
              </div>
            </td>
          </tr>
        {/each}
      </tbody>
    </table>

    {#if sortedFindings.length === 0}
      <div class="text-center py-12">
        {#if loading}
          <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Loading vulnerabilities...</span>
          </div>
        {:else}
          <div class="text-gray-500">
            <AlertTriangle size={48} class="mx-auto mb-4 text-gray-400" />
            <p class="text-lg font-medium">No vulnerabilities found</p>
            <p class="text-sm">Try adjusting your filters or check if checklists have been imported.</p>
          </div>
        {/if}
      </div>
    {/if}
  </div>
</div>

<style>
  .vulnerability-table {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  input[type="checkbox"]:indeterminate {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid #d1d5db;
    border-radius: 2px;
    background-color: #fff;
    position: relative;
  }

  input[type="checkbox"]:indeterminate::after {
    content: '';
    position: absolute;
    width: 8px;
    height: 2px;
    background-color: #3b82f6;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
</style>
