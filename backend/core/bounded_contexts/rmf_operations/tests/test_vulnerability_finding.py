"""
Unit tests for VulnerabilityFinding aggregate.
"""

import uuid
import pytest
from django.utils import timezone
from django.core.exceptions import ValidationError

from ..aggregates.vulnerability_finding import VulnerabilityFinding
from ..value_objects import VulnerabilityStatus, SeverityCategory


class TestVulnerabilityFinding:
    """Test VulnerabilityFinding aggregate."""

    def test_create_finding(self):
        """Test creating a vulnerability finding."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        assert finding.checklistId == checklist_id
        assert finding.vulnId == "V-12345"
        assert finding.stigId == "Windows_2019_STIG"
        assert finding.ruleId == "SV-12345r1_rule"
        assert finding.ruleTitle == "Test Rule Title"
        assert finding.severity.category == "cat1"
        assert finding.vulnerability_status.status == "not_reviewed"
        assert finding.ruleDiscussion == ""
        assert finding.checkContent == ""
        assert finding.fixText == ""
        assert finding.cciIds == []
        assert finding.tags == []

    def test_update_status(self):
        """Test updating vulnerability status."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        finding.update_status("open", "Test finding details", "Test comments")

        assert finding.vulnerability_status.status == "open"
        assert finding.vulnerability_status.finding_details == "Test finding details"
        assert finding.vulnerability_status.comments == "Test comments"

    def test_set_severity_override(self):
        """Test setting severity override."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        finding.set_severity_override("medium", "Business justification")

        assert finding.vulnerability_status.severity_override == "medium"
        assert finding.vulnerability_status.severity_justification == "Business justification"
        assert finding.has_severity_override()

    def test_add_remove_cci_reference(self):
        """Test adding and removing CCI references."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        finding.add_cci_reference("CCI-000001")
        finding.add_cci_reference("CCI-000002")

        assert "CCI-000001" in finding.cciIds
        assert "CCI-000002" in finding.cciIds

        finding.remove_cci_reference("CCI-000001")
        assert "CCI-000001" not in finding.cciIds
        assert "CCI-000002" in finding.cciIds

    def test_status_checking_methods(self):
        """Test status checking methods."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        # Initially not reviewed
        assert not finding.is_open()
        assert finding.is_closed()
        assert finding.requires_review()

        # Update to open
        finding.update_status("open")
        assert finding.is_open()
        assert not finding.is_closed()
        assert finding.requires_review()

        # Update to closed
        finding.update_status("not_a_finding")
        assert not finding.is_open()
        assert finding.is_closed()
        assert not finding.requires_review()

    def test_get_effective_severity(self):
        """Test getting effective severity with overrides."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        # Without override
        assert finding.get_effective_severity().is_high()

        # With override
        finding.set_severity_override("low", "Business justification")
        assert finding.get_effective_severity().is_low()

    def test_display_methods(self):
        """Test display methods."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        finding.update_status("open")
        finding.set_severity_override("medium", "Test justification")

        assert finding.get_display_status() == "Open"
        assert finding.get_display_severity() == "CAT I (overridden)"

    def test_bulk_update_eligibility(self):
        """Test bulk update eligibility."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        # Not reviewed should be eligible for bulk update
        assert finding.can_be_bulk_updated()

        # Open should not be eligible
        finding.update_status("open")
        assert not finding.can_be_bulk_updated()

    def test_save_validation(self):
        """Test validation during save."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        # Valid severity category should work
        finding.save()

        # Invalid severity category should raise ValidationError
        finding.severity_category = "invalid"
        with pytest.raises(ValidationError):
            finding.save()

    def test_str_representation(self):
        """Test string representation."""
        finding = VulnerabilityFinding()
        checklist_id = uuid.uuid4()

        finding.create_finding(
            checklist_id=checklist_id,
            vuln_id="V-12345",
            stig_id="Windows_2019_STIG",
            rule_id="SV-12345r1_rule",
            rule_title="Test Rule Title",
            severity_category="cat1"
        )

        expected = f"VulnerabilityFinding({finding.id}): V-12345 - Test Rule Title"
        assert str(finding) == expected
