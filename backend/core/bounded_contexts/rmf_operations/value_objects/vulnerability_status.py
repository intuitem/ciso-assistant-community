"""
Vulnerability Status Value Object

Represents the status of a vulnerability finding in RMF operations.
"""

from typing import Optional
from django.core.exceptions import ValidationError

from core.domain.value_object import ValueObject


class VulnerabilityStatus(ValueObject):
    """
    Vulnerability Status value object.

    Represents the current status of a vulnerability finding with optional
    justification and severity override.
    """

    VALID_STATUSES = {
        'open': 'Open',
        'not_a_finding': 'Not a Finding',
        'not_applicable': 'Not Applicable',
        'not_reviewed': 'Not Reviewed'
    }

    VALID_SEVERITY_OVERRIDES = {
        'high': 'High',
        'medium': 'Medium',
        'low': 'Low'
    }

    def __init__(self, status: str, finding_details: Optional[str] = None,
                 comments: Optional[str] = None, severity_override: Optional[str] = None,
                 severity_justification: Optional[str] = None):
        """
        Initialize vulnerability status.

        Args:
            status: Current status ('open', 'not_a_finding', 'not_applicable', 'not_reviewed')
            finding_details: Details about the finding
            comments: Additional comments
            severity_override: Override severity ('high', 'medium', 'low')
            severity_justification: Justification for severity override
        """
        self.status = status
        self.finding_details = finding_details or ""
        self.comments = comments or ""
        self.severity_override = severity_override
        self.severity_justification = severity_justification or ""

        self._validate()

    def _validate(self) -> None:
        """Validate the status value object"""
        if self.status not in self.VALID_STATUSES:
            raise ValidationError(
                f"Invalid status '{self.status}'. Must be one of: {list(self.VALID_STATUSES.keys())}"
            )

        if self.severity_override and self.severity_override not in self.VALID_SEVERITY_OVERRIDES:
            raise ValidationError(
                f"Invalid severity override '{self.severity_override}'. "
                f"Must be one of: {list(self.VALID_SEVERITY_OVERRIDES.keys())}"
            )

        if self.severity_override and not self.severity_justification.strip():
            raise ValidationError(
                "Severity justification is required when severity override is specified"
            )

    def is_open(self) -> bool:
        """Check if vulnerability is open"""
        return self.status == 'open'

    def is_closed(self) -> bool:
        """Check if vulnerability is closed (not open)"""
        return not self.is_open()

    def requires_review(self) -> bool:
        """Check if vulnerability requires review"""
        return self.status in ['open', 'not_reviewed']

    def has_severity_override(self) -> bool:
        """Check if severity has been overridden"""
        return self.severity_override is not None

    def get_display_status(self) -> str:
        """Get human-readable status"""
        return self.VALID_STATUSES.get(self.status, self.status)

    def get_display_severity_override(self) -> str:
        """Get human-readable severity override"""
        if not self.severity_override:
            return ""
        return self.VALID_SEVERITY_OVERRIDES.get(self.severity_override, self.severity_override)

    def can_be_bulk_updated(self) -> bool:
        """Check if this status can be part of bulk updates"""
        # Typically, 'not_reviewed' statuses are good candidates for bulk updates
        return self.status == 'not_reviewed'

    def __str__(self) -> str:
        override_str = f" (overridden to {self.get_display_severity_override()})" if self.has_severity_override() else ""
        return f"{self.get_display_status()}{override_str}"
