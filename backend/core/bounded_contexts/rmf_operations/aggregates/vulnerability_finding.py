"""
VulnerabilityFinding Aggregate

Represents a vulnerability finding within a STIG checklist.
"""

import uuid
from typing import Optional
from django.db import models
from django.utils import timezone
from django.core.exceptions import ValidationError

from core.domain.aggregate import AggregateRoot
from .value_objects import VulnerabilityStatus, SeverityCategory


class VulnerabilityFinding(AggregateRoot):
    """
    Vulnerability Finding aggregate.

    Represents a single vulnerability finding within a STIG checklist,
    including its status, severity, and assessment details.
    """

    # Identity and relationships
    checklistId = models.UUIDField(
        db_index=True,
        help_text="ID of the STIG checklist this finding belongs to"
    )
    vulnId = models.CharField(
        max_length=50,
        db_index=True,
        help_text="Vulnerability ID (e.g., 'V-12345')"
    )
    stigId = models.CharField(
        max_length=50,
        db_index=True,
        help_text="STIG ID reference"
    )
    ruleId = models.CharField(
        max_length=50,
        help_text="Rule ID"
    )

    # Vulnerability details
    ruleTitle = models.CharField(
        max_length=500,
        help_text="Rule title"
    )
    ruleDiscussion = models.TextField(
        blank=True,
        null=True,
        help_text="Rule discussion/explanation"
    )
    checkContent = models.TextField(
        blank=True,
        null=True,
        help_text="Check content/procedure"
    )
    fixText = models.TextField(
        blank=True,
        null=True,
        help_text="Fix text/remediation"
    )

    # Status and severity (stored as JSON for value objects)
    status_data = models.JSONField(
        default=dict,
        help_text="Vulnerability status data"
    )
    severity_category = models.CharField(
        max_length=10,
        db_index=True,
        help_text="Severity category (cat1, cat2, cat3)"
    )

    # Additional metadata
    ruleVersion = models.CharField(
        max_length=50,
        blank=True,
        help_text="Rule version"
    )
    cciIds = models.JSONField(
        default=list,
        help_text="Common Control Identifier IDs"
    )

    # Metadata
    tags = models.JSONField(
        default=list,
        blank=True,
        help_text="Finding tags"
    )

    class Meta:
        db_table = 'rmf_vulnerability_findings'
        verbose_name = 'Vulnerability Finding'
        verbose_name_plural = 'Vulnerability Findings'
        ordering = ['-updated_at']
        indexes = [
            models.Index(fields=['checklistId', 'status_data']),
            models.Index(fields=['severity_category', 'status_data']),
            models.Index(fields=['stigId']),
            models.Index(fields=['vulnId']),
            models.Index(fields=['created_at']),
            models.Index(fields=['updated_at']),
        ]
        # Ensure unique vulnId per checklist
        unique_together = [['checklistId', 'vulnId']]

    def __str__(self):
        return f"VulnerabilityFinding({self.id}): {self.vulnId} - {self.ruleTitle[:50]}"

    def save(self, *args, **kwargs):
        """Override save to handle value objects"""
        # Ensure status_data is populated
        if not self.status_data:
            status = VulnerabilityStatus('not_reviewed')
            self.status_data = {
                'status': status.status,
                'finding_details': status.finding_details,
                'comments': status.comments,
                'severity_override': status.severity_override,
                'severity_justification': status.severity_justification
            }

        # Validate severity category
        try:
            SeverityCategory(self.severity_category)
        except ValidationError as e:
            raise ValidationError(f"Invalid severity category: {e}")

        super().save(*args, **kwargs)

    # Property accessors for value objects
    @property
    def vulnerability_status(self) -> VulnerabilityStatus:
        """Get the vulnerability status value object"""
        return VulnerabilityStatus(**self.status_data)

    @vulnerability_status.setter
    def vulnerability_status(self, status: VulnerabilityStatus) -> None:
        """Set the vulnerability status value object"""
        self.status_data = {
            'status': status.status,
            'finding_details': status.finding_details,
            'comments': status.comments,
            'severity_override': status.severity_override,
            'severity_justification': status.severity_justification
        }

    @property
    def severity(self) -> SeverityCategory:
        """Get the severity category value object"""
        return SeverityCategory(self.severity_category)

    @severity.setter
    def severity(self, category: SeverityCategory) -> None:
        """Set the severity category value object"""
        self.severity_category = category.category

    # Business methods
    def create_finding(self, checklist_id: uuid.UUID, vuln_id: str,
                      stig_id: str, rule_id: str, rule_title: str,
                      severity_category: str) -> None:
        """Create a new vulnerability finding"""
        self.checklistId = checklist_id
        self.vulnId = vuln_id
        self.stigId = stig_id
        self.ruleId = rule_id
        self.ruleTitle = rule_title
        self.severity_category = severity_category.lower()
        self.ruleDiscussion = ""
        self.checkContent = ""
        self.fixText = ""
        self.ruleVersion = ""
        self.cciIds = []
        self.tags = []

        # Initialize with default status
        self.vulnerability_status = VulnerabilityStatus('not_reviewed')

        from ..domain_events import VulnerabilityFindingCreated
        self._raise_event(VulnerabilityFindingCreated(
            aggregate_id=self.id,
            checklist_id=str(checklist_id),
            vuln_id=vuln_id,
            stig_id=stig_id
        ))

    def update_status(self, new_status: str, finding_details: Optional[str] = None,
                     comments: Optional[str] = None) -> None:
        """Update the vulnerability status"""
        old_status = self.vulnerability_status.status

        self.vulnerability_status = VulnerabilityStatus(
            status=new_status,
            finding_details=finding_details,
            comments=comments,
            severity_override=self.vulnerability_status.severity_override,
            severity_justification=self.vulnerability_status.severity_justification
        )

        if old_status != new_status:
            from ..domain_events import VulnerabilityFindingStatusChanged
            self._raise_event(VulnerabilityFindingStatusChanged(
                aggregate_id=self.id,
                vuln_id=self.vulnId,
                old_status=old_status,
                new_status=new_status
            ))

    def set_severity_override(self, severity_override: Optional[str],
                             justification: str) -> None:
        """Set or remove severity override"""
        old_override = self.vulnerability_status.severity_override

        self.vulnerability_status = VulnerabilityStatus(
            status=self.vulnerability_status.status,
            finding_details=self.vulnerability_status.finding_details,
            comments=self.vulnerability_status.comments,
            severity_override=severity_override,
            severity_justification=justification
        )

        if old_override != severity_override:
            from ..domain_events import VulnerabilityFindingSeverityOverridden
            self._raise_event(VulnerabilityFindingSeverityOverridden(
                aggregate_id=self.id,
                vuln_id=self.vulnId,
                old_severity_override=old_override,
                new_severity_override=severity_override
            ))

    def add_cci_reference(self, cci_id: str) -> None:
        """Add a CCI reference"""
        if cci_id not in self.cciIds:
            self.cciIds.append(cci_id)

    def remove_cci_reference(self, cci_id: str) -> None:
        """Remove a CCI reference"""
        if cci_id in self.cciIds:
            self.cciIds.remove(cci_id)

    # Query methods
    def is_open(self) -> bool:
        """Check if finding is open"""
        return self.vulnerability_status.is_open()

    def is_closed(self) -> bool:
        """Check if finding is closed"""
        return self.vulnerability_status.is_closed()

    def requires_review(self) -> bool:
        """Check if finding requires review"""
        return self.vulnerability_status.requires_review()

    def has_severity_override(self) -> bool:
        """Check if severity has been overridden"""
        return self.vulnerability_status.has_severity_override()

    def get_effective_severity(self) -> SeverityCategory:
        """Get the effective severity (with override if present)"""
        if self.has_severity_override():
            return SeverityCategory(self.vulnerability_status.severity_override)
        return self.severity

    def can_be_bulk_updated(self) -> bool:
        """Check if this finding can be part of bulk updates"""
        return self.vulnerability_status.can_be_bulk_updated()

    def get_display_status(self) -> str:
        """Get human-readable status"""
        return self.vulnerability_status.get_display_status()

    def get_display_severity(self) -> str:
        """Get human-readable severity"""
        effective = self.get_effective_severity()
        override_str = " (overridden)" if self.has_severity_override() else ""
        return f"{effective.name}{override_str}"
