---
apiVersion: v1
kind: Namespace
metadata:
  name: ciso-assistant
  labels:
    name: ciso-assistant
    app: ciso-assistant

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ciso-assistant-config
  namespace: ciso-assistant
data:
  DJANGO_SETTINGS_MODULE: "ciso_assistant.settings"
  DEBUG: "False"
  LOG_LEVEL: "INFO"
  LOG_FORMAT: "json"
  PROMETHEUS_ENABLED: "True"

---
apiVersion: v1
kind: Secret
metadata:
  name: ciso-assistant-secrets
  namespace: ciso-assistant
type: Opaque
data:
  # Base64 encoded values - replace with your actual secrets
  SECRET_KEY: "eW91ci12ZXJ5LXNlY3VyZS1kamFuZ28tc2VjcmV0LWtleQ=="  # your-very-secure-django-secret-key
  POSTGRES_PASSWORD: "eW91ci1zZWN1cmUtZGItcGFzc3dvcmQ="  # your-secure-db-password
  REDIS_PASSWORD: "eW91ci1zZWN1cmUtcmVkaXMtZGF0YQ=="  # your-secure-redis-password
  GRAFANA_PASSWORD: "YWRtaW4="  # admin

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: ciso-assistant
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: ciso-assistant
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: ciso-assistant
  labels:
    app: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "ciso_assistant"
        - name: POSTGRES_USER
          value: "ciso_user"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ciso-assistant-secrets
              key: POSTGRES_PASSWORD
        - name: PGDATA
          value: "/var/lib/postgresql/data/pgdata"
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: postgres-init
          mountPath: /docker-entrypoint-initdb.d
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - ciso_user
            - -d
            - ciso_assistant
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - ciso_user
            - -d
            - ciso_assistant
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-pvc
      - name: postgres-init
        configMap:
          name: postgres-init-config

---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: ciso-assistant
  labels:
    app: postgres
spec:
  ports:
  - port: 5432
    targetPort: 5432
  selector:
    app: postgres

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: ciso-assistant
  labels:
    app: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        command: ["redis-server", "--appendonly", "yes", "--requirepass", "$(REDIS_PASSWORD)"]
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ciso-assistant-secrets
              key: REDIS_PASSWORD
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          exec:
            command:
            - redis-cli
            - --raw
            - incr
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - redis-cli
            - --raw
            - incr
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: redis-storage
        persistentVolumeClaim:
          claimName: redis-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: ciso-assistant
  labels:
    app: redis
spec:
  ports:
  - port: 6379
    targetPort: 6379
  selector:
    app: redis

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ciso-assistant-backend
  namespace: ciso-assistant
  labels:
    app: ciso-assistant-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ciso-assistant-backend
  template:
    metadata:
      labels:
        app: ciso-assistant-backend
    spec:
      containers:
      - name: backend
        image: ciso-assistant-backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: DJANGO_SETTINGS_MODULE
          valueFrom:
            configMapKeyRef:
              name: ciso-assistant-config
              key: DJANGO_SETTINGS_MODULE
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: ciso-assistant-secrets
              key: SECRET_KEY
        - name: DATABASE_URL
          value: "postgresql://ciso_user:$(POSTGRES_PASSWORD)@postgres:5432/ciso_assistant"
        - name: REDIS_URL
          value: "redis://:$(REDIS_PASSWORD)@redis:6379/0"
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: ciso-assistant-config
              key: DEBUG
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: ciso-assistant-config
              key: LOG_LEVEL
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ciso-assistant-secrets
              key: POSTGRES_PASSWORD
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ciso-assistant-secrets
              key: REDIS_PASSWORD
        envFrom:
        - configMapRef:
            name: ciso-assistant-config
        volumeMounts:
        - name: static-files
          mountPath: /app/static
        - name: media-files
          mountPath: /app/media
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health/
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/health/
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: static-files
        emptyDir: {}
      - name: media-files
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: ciso-assistant-backend
  namespace: ciso-assistant
  labels:
    app: ciso-assistant-backend
spec:
  ports:
  - port: 8000
    targetPort: 8000
  selector:
    app: ciso-assistant-backend
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ciso-assistant-frontend
  namespace: ciso-assistant
  labels:
    app: ciso-assistant-frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ciso-assistant-frontend
  template:
    metadata:
      labels:
        app: ciso-assistant-frontend
    spec:
      containers:
      - name: frontend
        image: ciso-assistant-frontend:latest
        ports:
        - containerPort: 5173
        env:
        - name: PUBLIC_API_BASE_URL
          value: "http://ciso-assistant-backend:8000"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 5173
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 5173
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: ciso-assistant-frontend
  namespace: ciso-assistant
  labels:
    app: ciso-assistant-frontend
spec:
  ports:
  - port: 5173
    targetPort: 5173
  selector:
    app: ciso-assistant-frontend
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: ciso-assistant
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.25-alpine
        ports:
        - containerPort: 80
        - containerPort: 443
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: static-files
          mountPath: /var/www/static
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: static-files
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: ciso-assistant-nginx
  namespace: ciso-assistant
  labels:
    app: nginx
spec:
  ports:
  - name: http
    port: 80
    targetPort: 80
  - name: https
    port: 443
    targetPort: 443
  selector:
    app: nginx
  type: LoadBalancer

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ciso-assistant-ingress
  namespace: ciso-assistant
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - your-domain.com
    secretName: ciso-assistant-tls
  rules:
  - host: your-domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ciso-assistant-nginx
            port:
              number: 80

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-config
  namespace: ciso-assistant
data:
  init.sql: |
    -- PostgreSQL initialization script
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: ciso-assistant
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        client_max_body_size 100M;

        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        upstream backend {
            server ciso-assistant-backend:8000;
        }

        upstream frontend {
            server ciso-assistant-frontend:5173;
        }

        server {
            listen 80;
            server_name _;

            location /api/ {
                proxy_pass http://backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            location / {
                proxy_pass http://frontend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            location /static/ {
                alias /var/www/static/;
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }
    }

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ciso-assistant-sa
  namespace: ciso-assistant

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ciso-assistant-role
  namespace: ciso-assistant
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints", "configmaps", "secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ciso-assistant-rolebinding
  namespace: ciso-assistant
subjects:
- kind: ServiceAccount
  name: ciso-assistant-sa
  namespace: ciso-assistant
roleRef:
  kind: Role
  name: ciso-assistant-role
  apiGroup: rbac.authorization.k8s.io
